<!DOCTYPE html>
<html>
<head>
    <title>Your Calculations</title>
</head>
<body>
    <h1>Calculations</h1>
    <p id="userinfo"></p>

    <h2>Create Calculation</h2>
    <input id="a" type="number" placeholder="A">
    <input id="b" type="number" placeholder="B">
    <select id="type">
        <option value="add">Add</option>
        <option value="subtract">Subtract</option>
        <option value="multiply">Multiply</option>
        <option value="divide">Divide</option>
    </select>
    <button id="createBtn">Submit</button>

    <h2>Your Calculation History</h2>
    <ul id="list"></ul>

    <script>
        const token = localStorage.getItem("token");
        if (!token) {
            window.location.href = "login.html";
        }

        let currentUserId = null;

        async function loadUser() {
            try {
                const res = await fetch("http://host.docker.internal:8000/me", {
                    headers: { Authorization: "Bearer " + token }
                });
                if (!res.ok) throw new Error("Failed to fetch user info");
                const data = await res.json();
                currentUserId = data.id;
                document.getElementById("userinfo").textContent = `Logged in as: ${data.email}`;
                await loadCalculations();
            } catch (err) {
                console.error(err);
                window.location.href = "login.html";
            }
        }

        async function loadCalculations() {
            if (!currentUserId) return;
            try {
                const res = await fetch(`http://host.docker.internal:8000/calculations/user/${currentUserId}`, {
                    headers: { Authorization: "Bearer " + token }
                });
                if (!res.ok) throw new Error("Failed to load calculations");
                const data = await res.json();
                const list = document.getElementById("list");
                list.innerHTML = "";
                if (data.length === 0) {
                    list.innerHTML = "<li>No calculations yet.</li>";
                } else {
                    data.forEach(c => {
                        const li = document.createElement("li");
                        li.textContent = `${c.type}: ${c.a} and ${c.b} = ${c.result}`;
                        list.appendChild(li);
                    });
                }
            } catch (err) {
                console.error(err);
            }
        }

        async function createCalculation() {
            const a = parseFloat(document.getElementById("a").value);
            const b = parseFloat(document.getElementById("b").value);
            const type = document.getElementById("type").value;

            try {
                const res = await fetch("http://host.docker.internal:8000/calculations", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token
                    },
                    body: JSON.stringify({ a, b, type }) // no user_id
                });
                if (!res.ok) throw new Error("Failed to create calculation");
                await loadCalculations();
            } catch (err) {
                console.error(err);
            }
        }

        document.getElementById("createBtn").onclick = createCalculation;

        loadUser();
    </script>
</body>
</html>
