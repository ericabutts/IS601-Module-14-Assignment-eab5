<!DOCTYPE html>
<html>
<head>
    <title>Your Calculations</title>
    <style>
        input, select, button {
            margin: 5px;
        }
        .calc-item {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>
    <h1>Calculations</h1>
    <p id="userinfo"></p>

    <h2>Create Calculation</h2>
    <input id="a" type="number" placeholder="A">
    <input id="b" type="number" placeholder="B">
    <select id="type">
        <option value="ADD">Add</option>
        <option value="SUBTRACT">Subtract</option>
        <option value="MULTIPLY">Multiply</option>
        <option value="DIVIDE">Divide</option>
    </select>
    <button id="createBtn">Submit</button>

    <h2>Your Calculation History</h2>
    <ul id="list"></ul>

    <script>
        const token = localStorage.getItem("token");
        if (!token) window.location.href = "login.html";

        let currentUserId = null;

        async function loadUser() {
            try {
                const res = await fetch("http://host.docker.internal:8000/me", {
                    headers: { Authorization: "Bearer " + token }
                });
                if (!res.ok) throw new Error("Failed to fetch user info");
                const data = await res.json();
                currentUserId = data.id;
                document.getElementById("userinfo").textContent = `Logged in as: ${data.email}`;
                await loadCalculations();
            } catch (err) {
                console.error(err);
                window.location.href = "login.html";
            }
        }

        async function loadCalculations() {
            if (!currentUserId) return;
            try {
                const res = await fetch(`http://host.docker.internal:8000/calculations/user/${currentUserId}`, {
                    headers: { Authorization: "Bearer " + token }
                });
                if (!res.ok) throw new Error("Failed to load calculations");
                const data = await res.json();
                const list = document.getElementById("list");
                list.innerHTML = "";

                if (data.length === 0) {
                    list.innerHTML = "<li>No calculations yet.</li>";
                    return;
                }

            data.forEach(c => {
                const li = document.createElement("li");
                li.textContent = `${c.type}: ${c.a} and ${c.b} = ${c.result}`;

                const editBtn = document.createElement("button");
                editBtn.textContent = "Edit";
                editBtn.addEventListener("click", () => editCalculation(c.id, c.a, c.b, c.type));

                const delBtn = document.createElement("button");
                delBtn.textContent = "Delete";
                delBtn.addEventListener("click", () => deleteCalculation(c.id));

                li.appendChild(editBtn);
                li.appendChild(delBtn);

                list.appendChild(li);
            });

            } catch (err) {
                console.error(err);
            }
        }

        async function createCalculation() {
            const a = parseFloat(document.getElementById("a").value);
            const b = parseFloat(document.getElementById("b").value);
            const type = document.getElementById("type").value;

            if (isNaN(a) || isNaN(b)) {
                alert("A and B must be numbers");
                return;
            }
            if (type === "DIVIDE" && b === 0) {
                alert("Cannot divide by zero");
                return;
            }

            try {
                const res = await fetch("http://host.docker.internal:8000/calculations", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token
                    },
                    body: JSON.stringify({ a, b, type })
                });
                if (!res.ok) throw new Error("Failed to create calculation");
                await loadCalculations();
            } catch (err) {
                console.error(err);
            }
        }

        async function editCalculation(id, a, b, type) {
            const newA = parseFloat(prompt("Enter new value for A:", a));
            const newB = parseFloat(prompt("Enter new value for B:", b));
            const newType = prompt("Enter new type (add, subtract, multiply, divide):", type);

            if (isNaN(newA) || isNaN(newB)) {
                alert("A and B must be numbers");
                return;
            }

            const upperType = newType?.toUpperCase();

            if (!["ADD", "SUBTRACT", "MULTIPLY", "DIVIDE"].includes(upperType)) {
                alert("Invalid operation type. Must be ADD, SUBTRACT, MULTIPLY, or DIVIDE.");
                return;
            }

            if (upperType === "DIVIDE" && newB === 0) {
                alert("Cannot divide by zero");
                return;
            }

            try {
                const res = await fetch(`http://host.docker.internal:8000/calculations/${id}`, {
                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json",
                        Authorization: "Bearer " + token
                    },
                    body: JSON.stringify({ a: newA, b: newB, type: upperType })
                });

                if (!res.ok) {
                    const errorData = await res.json();
                    throw new Error(errorData.detail || "Failed to update calculation");
                }

                await loadCalculations();
            } catch (err) {
                console.error(err);
                alert("Error updating calculation: " + err.message);
            }
        }




        async function deleteCalculation(id) {
            if (!confirm("Are you sure you want to delete this calculation?")) return;

            try {
                const res = await fetch(`http://host.docker.internal:8000/calculations/${id}`, {
                    method: "DELETE",
                    headers: { Authorization: "Bearer " + token }
                });
                if (!res.ok && res.status !== 204) throw new Error("Failed to delete calculation");
                await loadCalculations();
            } catch (err) {
                console.error(err);
            }
        }


        document.getElementById("createBtn").onclick = createCalculation;

        loadUser();
    </script>
</body>
</html>
